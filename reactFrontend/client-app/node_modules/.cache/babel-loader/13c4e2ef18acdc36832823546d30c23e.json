{"ast":null,"code":"import io from 'socket.io-client';\nimport Peer from 'peerjs';\n\nclass SocketConnection {\n  constructor(props) {\n    this.ENDPOINT = 'localhost:5000';\n    this.peer = new Peer();\n    this.socket = io(this.ENDPOINT);\n    this.peers = {};\n    this.videoContainer = {};\n    this.currentStream = null;\n    this.mediaRecorder = null;\n    this.recordedChunks = [];\n    this.roomId = props.roomId;\n    this.peer = new Peer();\n    this.socket = io(this.ENDPOINT);\n    console.log('inside the connection da ngotha :' + props.roomId);\n    this.socketEvent();\n    this.PeerEvent();\n  }\n\n  socketEvent() {\n    this.socket.on('screen-share', ID => {\n      this.changeMediaView(ID);\n    });\n    this.socket.on('user-left', Id => {\n      this.removeuser(Id);\n    });\n  }\n\n  PeerEvent() {\n    this.peer.on('open', id => {\n      this.userId = id;\n      console.log('generated userId: ' + id);\n      this.setlocalstream();\n      console.log(\"emitting joining room request\");\n      setTimeout(() => {\n        this.socket.emit('joining-room', this.roomId, id);\n      }, 1500);\n    });\n    this.peer.on('error', err => {\n      console.log('reconnecting to peer', err);\n      this.peer.reconnect();\n    });\n  }\n\n  newUserConnection() {\n    this.socket.on('user-joined', Id => {\n      console.log(\"joined use:\" + Id);\n      this.connectToUser(this.currentStream, Id);\n    });\n  }\n\n  connectToUser(stream, Id) {\n    const call = this.peer.call(Id, stream, {\n      metadata: {\n        userId: this.userId\n      }\n    });\n    this.peer.on('error', err => {\n      console.log(\"ERROR\" + err);\n    });\n    console.log('made call to ' + Id + 'stream');\n    call.on('stream', externalstream => {\n      console.log('connteced user returned stream');\n      this.addstream(externalstream, Id);\n    });\n    /*  call.on('close',()=>{\r\n           this.removeuser(Id);\r\n        })*/\n\n    this.peers[Id] = call.peerConnection;\n  }\n\n  setPeerListenres(stream) {\n    console.log('peerlisteners set');\n    this.peer.on('call', Call => {\n      Call.answer(stream);\n      Call.on('stream', externalstream => {\n        console.log('incoming stream');\n        this.peers[Call.metadata.userId] = Call.peerConnection;\n        this.addstream(externalstream, Call.metadata.userId);\n      });\n      /* Call.on('close',()=>{\r\n           this.removeuser(Call.metadata.userId);\r\n       })\r\n      */\n    });\n  }\n\n  setlocalstream() {\n    this.getvideoaudio(true, true).then(stream => {\n      this.localstream = stream;\n      this.currentStream = stream;\n      this.addstream(stream, this.userId);\n      this.setPeerListenres(this.currentStream);\n      this.newUserConnection();\n    }).catch(function (err) {\n      console.log(err.name + \": \" + err.message);\n    });\n  }\n\n  getvideoaudio(videostatus, micstatus) {\n    const myNavigator = navigator.mediaDevices.getUserMedia || navigator.mediaDevices.webkitGetUserMedia || navigator.mediaDevices.mozGetUserMedia || navigator.mediaDevices.msGetUserMedia;\n    return myNavigator({\n      video: videostatus,\n      audio: micstatus\n    });\n  }\n\n  addstream(stream, Id) {\n    if (!this.videoContainer[Id]) {\n      const videogrid = document.getElementById('video-grid');\n      this.videoContainer[Id] = stream;\n      const localcontainer = document.createElement('div');\n      const video = document.createElement('video');\n      video.srcObject = stream;\n      video.id = Id;\n      video.autoplay = true;\n      if (this.userId === Id) video.muted = true;\n      localcontainer.appendChild(video);\n      videogrid.append(localcontainer);\n      console.log(\"done creating video :\" + Id);\n    }\n  }\n\n  removeuser(Id) {\n    if (this.peers[Id]) this.peers[Id].close();\n    delete this.videoContainer[Id];\n    const video = document.getElementById(Id);\n    if (video) video.remove();\n    delete this.peers[Id];\n  }\n\n  videotoggle(videostatus) {\n    this.localstream.getVideoTracks()[0].enabled = !videostatus;\n  }\n\n  mictoggle(micStatus) {\n    this.localstream.getAudioTracks()[0].enabled = !micStatus;\n  }\n\n  screenSharetoggle() {\n    navigator.mediaDevices.getDisplayMedia({\n      video: {\n        cursor: \"always\"\n      },\n      audio: {\n        echoCancellation: true,\n        noiseSuppression: true\n      }\n    }).then(mediaStream => {\n      mediaStream.getVideoTracks()[0].onended = () => {\n        this.stopscreen();\n      };\n\n      for (const [key, value] of Object.entries(this.peers)) {\n        value.getSenders().map(sender => {\n          if (sender.track.kind == \"video\") {\n            if (mediaStream.getVideoTracks().length > 0) {\n              sender.replaceTrack(mediaStream.getVideoTracks()[0]);\n            }\n          }\n        });\n      }\n\n      if (mediaStream) {\n        this.currentStream = mediaStream;\n      }\n\n      var video = document.getElementById(this.userId);\n\n      if (video) {\n        video.pause();\n        video.srcObject = mediaStream;\n        video.play();\n      }\n    }).catch(err => {\n      console.log(\"unable to get screen stream\" + err);\n    });\n  }\n\n  stopscreen() {\n    var video = document.getElementById(this.userId);\n\n    if (video) {\n      video.pause();\n      video.srcObject = this.localstream;\n      video.play();\n    }\n\n    this.currentStream = this.localstream;\n\n    for (const [key, value] of Object.entries(this.peers)) {\n      value.getSenders().map(sender => {\n        if (sender.track.kind == \"video\") {\n          if (this.localstream.getVideoTracks().length > 0) {\n            sender.replaceTrack(this.localstream.getVideoTracks()[0]);\n          }\n        }\n      });\n    }\n  }\n\n  recordScreen(recordStatus) {\n    if (recordStatus) {\n      navigator.mediaDevices.getDisplayMedia({\n        video: {\n          cursor: \"always\"\n        },\n        audio: {\n          echoCancellation: true,\n          noiseSuppression: true\n        }\n      }).then(mediaStream => {\n        mediaStream.getVideoTracks()[0].onended = () => {\n          this.endrecording();\n        };\n\n        var options;\n\n        if (MediaRecorder.isTypeSupported('video/webm;codecs=vp9')) {\n          options = {\n            mimeType: 'video/webm; codecs=vp9'\n          };\n        } else if (MediaRecorder.isTypeSupported('video/webm;codecs=vp8')) {\n          options = {\n            mimeType: 'video/webm; codecs=vp8'\n          };\n        } else if (MediaRecorder.isTypeSupported('video/webm;codecs=h264,opus')) {\n          options = {\n            mimeType: 'video/webm;codecs=h264,opus'\n          };\n        } else {\n          options = {\n            mimeType: 'video/mp4;codecs=h264,aac'\n          };\n        }\n\n        this.mediaRecorder = new MediaRecorder(mediaStream, options);\n        this.mediaRecorder.ondataavailable = this.handleDataAvailable;\n        this.mediaRecorder.start();\n        console.log(\"starting\", this.mediaRecorder);\n      }).catch(err => {\n        console.log(\"unable to get screen stream for recording\" + err);\n      });\n    } else {\n      this.endrecording();\n    }\n  }\n\n  handleDataAvailable(event) {\n    console.log(\"storing data in chuckns\");\n\n    if (event.data.size > 0) {\n      this.recordedChunks.push(event.data);\n    }\n  }\n\n  endrecording() {\n    if (this.mediaRecorder) {\n      console.log(\"ending\", this.mediaRecorder);\n      this.mediaRecorder.stop();\n      const blob = new Blob(this.recordedChunks, {\n        type: this.recordedChunks[0].type\n      }); //'video/webm'});\n\n      const url = window.URL.createObjectURL(blob);\n      const a = document.createElement('a');\n      a.style.display = 'none';\n      a.href = url;\n      a.download = 'test.webm';\n      document.body.appendChild(a);\n      a.click();\n      setTimeout(() => {\n        document.body.removeChild(a);\n        window.URL.revokeObjectURL(url);\n      }, 100);\n      this.mediaRecorder = null;\n      this.recordedChunks = [];\n    }\n  }\n\n  exitcall() {\n    this.socket.disconnect();\n\n    if (this.videoContainer[this.userId]) {\n      const Tracks = this.videoContainer[this.userId].getTracks();\n      Tracks.forEach(element => {\n        element.stop();\n      });\n    }\n\n    delete this.videoContainer;\n    delete this.peer;\n    delete this.peers;\n  } //experimental\n\n\n  changeMediaView(userID, status) {\n    const userVideoDOM = document.getElementById(userID);\n\n    if (status) {\n      const clientPosition = userVideoDOM.getBoundingClientRect();\n      const createdCanvas = document.createElement(\"SPAN\");\n      createdCanvas.className = userID;\n      createdCanvas.style.position = 'absolute';\n      createdCanvas.style.left = `${clientPosition.left}px`;\n      createdCanvas.style.top = `${clientPosition.top}px`;\n      createdCanvas.style.width = `${userVideoDOM.videoWidth}px`;\n      createdCanvas.style.height = `${clientPosition.height}px`;\n      createdCanvas.style.width = '100%';\n      createdCanvas.style.height = '100%';\n      createdCanvas.style.backgroundColor = 'green';\n      userVideoDOM.parentElement.appendChild(createdCanvas);\n    } else {\n      const canvasElement = document.getElementsByClassName(userID);\n      if (canvasElement[0]) canvasElement[0].remove();\n    }\n  }\n\n}\n\nexport function createSocketConnectionInstance(settings = {}) {\n  return new SocketConnection(settings);\n}","map":{"version":3,"sources":["E:/Microsoft ENgae/reactFrontend/client-app/src/components/Connection.js"],"names":["io","Peer","SocketConnection","constructor","props","ENDPOINT","peer","socket","peers","videoContainer","currentStream","mediaRecorder","recordedChunks","roomId","console","log","socketEvent","PeerEvent","on","ID","changeMediaView","Id","removeuser","id","userId","setlocalstream","setTimeout","emit","err","reconnect","newUserConnection","connectToUser","stream","call","metadata","externalstream","addstream","peerConnection","setPeerListenres","Call","answer","getvideoaudio","then","localstream","catch","name","message","videostatus","micstatus","myNavigator","navigator","mediaDevices","getUserMedia","webkitGetUserMedia","mozGetUserMedia","msGetUserMedia","video","audio","videogrid","document","getElementById","localcontainer","createElement","srcObject","autoplay","muted","appendChild","append","close","remove","videotoggle","getVideoTracks","enabled","mictoggle","micStatus","getAudioTracks","screenSharetoggle","getDisplayMedia","cursor","echoCancellation","noiseSuppression","mediaStream","onended","stopscreen","key","value","Object","entries","getSenders","map","sender","track","kind","length","replaceTrack","pause","play","recordScreen","recordStatus","endrecording","options","MediaRecorder","isTypeSupported","mimeType","ondataavailable","handleDataAvailable","start","event","data","size","push","stop","blob","Blob","type","url","window","URL","createObjectURL","a","style","display","href","download","body","click","removeChild","revokeObjectURL","exitcall","disconnect","Tracks","getTracks","forEach","element","userID","status","userVideoDOM","clientPosition","getBoundingClientRect","createdCanvas","className","position","left","top","width","videoWidth","height","backgroundColor","parentElement","canvasElement","getElementsByClassName","createSocketConnectionInstance","settings"],"mappings":"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","sourcesContent":["import io from 'socket.io-client';\r\nimport Peer from 'peerjs';\r\n\r\n\r\nclass SocketConnection {\r\n    ENDPOINT='localhost:5000';\r\n    peer= new Peer();\r\n    socket=io(this.ENDPOINT);\r\n    peers={};\r\n    videoContainer={};\r\n    currentStream=null;\r\n    mediaRecorder=null;\r\n    recordedChunks=[];\r\n    constructor(props)\r\n    {\r\n        this.roomId=props.roomId;\r\n        this.peer=new Peer();\r\n        this.socket=io(this.ENDPOINT);\r\n        console.log('inside the connection da ngotha :'+props.roomId);\r\n        this.socketEvent();\r\n        this.PeerEvent();\r\n        \r\n        \r\n    }\r\n\r\n    socketEvent()\r\n    {\r\n        this.socket.on('screen-share',(ID)=>{\r\n            this.changeMediaView(ID);\r\n        })\r\n        \r\n        this.socket.on('user-left',(Id)=>{\r\n            this.removeuser(Id);\r\n        })\r\n    }\r\n\r\n    PeerEvent()\r\n    {\r\n       \r\n        this.peer.on('open',(id) =>{\r\n            this.userId=id;\r\n            console.log('generated userId: '+id);\r\n            this.setlocalstream();\r\n            console.log(\"emitting joining room request\")\r\n            setTimeout(()=>{this.socket.emit('joining-room', this.roomId, id)},1500);\r\n           \r\n            \r\n            \r\n       });\r\n       this.peer.on('error',(err)=>{\r\n           console.log('reconnecting to peer',err);\r\n           this.peer.reconnect();\r\n       })\r\n      \r\n        \r\n    }\r\n\r\n    newUserConnection()\r\n    {\r\n        this.socket.on('user-joined',(Id)=>{\r\n           \r\n            console.log(\"joined use:\"+Id);\r\n          \r\n                this.connectToUser(this.currentStream,Id);\r\n            \r\n            \r\n            \r\n           \r\n            \r\n          \r\n        });\r\n      \r\n\r\n    }\r\n    connectToUser(stream,Id)\r\n        {\r\n       \r\n            const call=this.peer.call(Id,stream,{ metadata: { userId: this.userId } });\r\n            this.peer.on('error',(err)=>{\r\n                console.log(\"ERROR\"+err);\r\n            })\r\n            console.log('made call to '+ Id+ 'stream');\r\n            call.on('stream',(externalstream)=>{\r\n                console.log('connteced user returned stream');\r\n                this.addstream(externalstream,Id);\r\n            })\r\n        /*  call.on('close',()=>{\r\n               this.removeuser(Id);\r\n            })*/\r\n            this.peers[Id]=call.peerConnection;\r\n          \r\n        }\r\n   \r\n    \r\n    setPeerListenres(stream)\r\n    {\r\n        console.log('peerlisteners set');\r\n        this.peer.on('call', (Call) =>{\r\n           \r\n            Call.answer(stream);\r\n            Call.on('stream',(externalstream)=>{\r\n             console.log('incoming stream');\r\n             this.peers[Call.metadata.userId]=Call.peerConnection;\r\n                this.addstream(externalstream,Call.metadata.userId);\r\n            })\r\n           /* Call.on('close',()=>{\r\n                this.removeuser(Call.metadata.userId);\r\n            })\r\n           */\r\n        })\r\n    }\r\n    setlocalstream()\r\n    { \r\n        \r\n       this.getvideoaudio(true,true).then((stream)=> {\r\n         this.localstream=stream;\r\n         this.currentStream=stream;\r\n        this.addstream(stream,this.userId);\r\n        this.setPeerListenres(this.currentStream);\r\n        this.newUserConnection();\r\n      })\r\n      .catch(function(err) { console.log(err.name + \": \" + err.message); });\r\n     \r\n    }\r\n    getvideoaudio(videostatus,micstatus)\r\n    {\r\n        const myNavigator = navigator.mediaDevices.getUserMedia || navigator.mediaDevices.webkitGetUserMedia || navigator.mediaDevices.mozGetUserMedia || navigator.mediaDevices.msGetUserMedia;\r\n        return myNavigator({video:videostatus,audio :micstatus});\r\n    }\r\n    \r\n    \r\n    addstream(stream,Id)\r\n   {\r\n       if(!this.videoContainer[Id])\r\n       {\r\n        const videogrid=document.getElementById('video-grid');\r\n      \r\n        this.videoContainer[Id]=stream;\r\n        const localcontainer = document.createElement('div');\r\n        const video = document.createElement('video');\r\n        video.srcObject =stream;\r\n        video.id=Id;\r\n        video.autoplay = true;\r\n        if (this.userId === Id) video.muted = true;\r\n        localcontainer.appendChild(video)\r\n        videogrid.append(localcontainer);\r\n        console.log(\"done creating video :\"+Id);\r\n       \r\n        \r\n       }\r\n      \r\n   }\r\n\r\n   removeuser(Id)\r\n   {\r\n    if(this.peers[Id])this.peers[Id].close();\r\n    delete this.videoContainer[Id];\r\n    const video = document.getElementById(Id);\r\n    if (video) video.remove();\r\n    delete this.peers[Id];\r\n    \r\n\r\n   }\r\n   \r\n\r\n\r\n   videotoggle(videostatus)\r\n   {\r\n    this.localstream.getVideoTracks()[0].enabled =!videostatus; \r\n   }\r\n\r\n\r\n   mictoggle(micStatus)\r\n   {\r\n    this.localstream.getAudioTracks()[0].enabled =!micStatus;\r\n   }\r\n\r\n\r\n\r\n   screenSharetoggle()\r\n   {\r\n    \r\n   \r\n    \r\n       navigator.mediaDevices.getDisplayMedia({\r\n           video: {\r\n               cursor: \"always\"\r\n           },\r\n           audio: {\r\n               echoCancellation: true,\r\n               noiseSuppression: true\r\n\r\n           }\r\n       }).then((mediaStream)=>{\r\n           mediaStream.getVideoTracks()[0].onended=()=>\r\n           {\r\n             \r\n           this.stopscreen();\r\n           }\r\n        \r\n        for (const [key, value] of Object.entries(this.peers)) {\r\n           \r\n            value.getSenders().map((sender) => {\r\n               \r\n                if(sender.track.kind == \"video\") {\r\n                    if(mediaStream.getVideoTracks().length > 0){\r\n                        sender.replaceTrack(mediaStream.getVideoTracks()[0]);\r\n                    }\r\n                }\r\n            });\r\n          }\r\n          if(mediaStream)\r\n          {\r\n            this.currentStream=mediaStream;\r\n          }\r\n         \r\n          var video = document.getElementById(this.userId);\r\n          if(video)\r\n          {\r\n            video.pause();\r\n            video.srcObject = mediaStream;\r\n            video.play();\r\n          }\r\n         \r\n\r\n        }).catch((err)=>{\r\n            console.log(\"unable to get screen stream\"+err)\r\n        })\r\n\r\n           \r\n   }\r\n   \r\n \r\n    stopscreen()\r\n    {\r\n       \r\n        var video = document.getElementById(this.userId);\r\n        if(video)\r\n        {\r\n            video.pause();\r\n            video.srcObject = this.localstream;\r\n            video.play();\r\n        }\r\n         \r\n          this.currentStream=this.localstream\r\n        for (const [key, value] of Object.entries(this.peers)) {\r\n            \r\n            value.getSenders().map((sender) => {\r\n            \r\n                if(sender.track.kind == \"video\") {\r\n                    if(this.localstream.getVideoTracks().length > 0){\r\n                        sender.replaceTrack(this.localstream.getVideoTracks()[0]);\r\n                    }\r\n                }\r\n            });\r\n        }\r\n    }\r\n\r\n    recordScreen(recordStatus){\r\n\r\n        if(recordStatus)\r\n        {\r\n            navigator.mediaDevices.getDisplayMedia({\r\n                video: {\r\n                    cursor: \"always\"\r\n                },\r\n                audio: {\r\n                    echoCancellation: true,\r\n                    noiseSuppression: true\r\n     \r\n                }\r\n            }).then((mediaStream)=>{\r\n                mediaStream.getVideoTracks()[0].onended=()=>\r\n                {\r\n                  \r\n                this.endrecording();\r\n                }\r\n                var options;\r\n                if (MediaRecorder.isTypeSupported('video/webm;codecs=vp9')) {\r\n                options = {mimeType: 'video/webm; codecs=vp9'};\r\n                } \r\n                else if (MediaRecorder.isTypeSupported('video/webm;codecs=vp8')) {\r\n                options = {mimeType: 'video/webm; codecs=vp8'};\r\n                } \r\n                else if (MediaRecorder.isTypeSupported('video/webm;codecs=h264,opus')) {\r\n                    options = {mimeType: 'video/webm;codecs=h264,opus'};\r\n                    } \r\n                else\r\n                {\r\n                    options = {mimeType: 'video/mp4;codecs=h264,aac'};\r\n                }\r\n               \r\n                this.mediaRecorder=new MediaRecorder(mediaStream,options);\r\n                this.mediaRecorder.ondataavailable=this.handleDataAvailable;\r\n    \r\n                this.mediaRecorder.start();\r\n                console.log(\"starting\",this.mediaRecorder);\r\n            \r\n            }).catch((err)=>{\r\n                console.log(\"unable to get screen stream for recording\"+err)\r\n            })\r\n         \r\n        }\r\n        else\r\n        {\r\n            this.endrecording();\r\n           \r\n        }\r\n        \r\n    }\r\n     handleDataAvailable(event){\r\n        console.log(\"storing data in chuckns\");\r\n            if (event.data.size > 0) \r\n            {\r\n                this.recordedChunks.push(event.data);\r\n            }\r\n               \r\n        \r\n    }\r\n\r\n    endrecording()\r\n    {\r\n        if(this.mediaRecorder)\r\n        {\r\n            console.log(\"ending\",this.mediaRecorder);\r\n            this.mediaRecorder.stop();\r\n            const blob = new Blob(this.recordedChunks, {type: this.recordedChunks[0].type});//'video/webm'});\r\n            const url = window.URL.createObjectURL(blob);\r\n            const a = document.createElement('a');\r\n            a.style.display = 'none';\r\n            a.href = url;\r\n            a.download = 'test.webm';\r\n            document.body.appendChild(a);\r\n            a.click();\r\n            setTimeout(() => {\r\n              document.body.removeChild(a);\r\n              window.URL.revokeObjectURL(url);\r\n            }, 100);\r\n              this.mediaRecorder=null;\r\n              this.recordedChunks=[];\r\n        }\r\n       \r\n    }\r\n    exitcall()\r\n    {\r\n     this.socket.disconnect();\r\n     if(this.videoContainer[this.userId])\r\n     {\r\n         const Tracks = this.videoContainer[this.userId].getTracks();\r\n         Tracks.forEach(element => {element.stop();\r\n             \r\n         });\r\n     }\r\n    \r\n        delete(this.videoContainer);\r\n        delete(this.peer);\r\n        delete(this.peers);\r\n       \r\n    }\r\n \r\n\r\n\r\n \r\n//experimental\r\n   changeMediaView(userID, status){\r\n    const userVideoDOM = document.getElementById(userID);\r\n    if (status) {\r\n        const clientPosition = userVideoDOM.getBoundingClientRect();\r\n        const createdCanvas = document.createElement(\"SPAN\");\r\n        createdCanvas.className = userID;\r\n        createdCanvas.style.position = 'absolute';\r\n        createdCanvas.style.left = `${clientPosition.left}px`;\r\n        createdCanvas.style.top = `${clientPosition.top}px`;\r\n        createdCanvas.style.width = `${userVideoDOM.videoWidth}px`;\r\n        createdCanvas.style.height = `${clientPosition.height}px`;\r\n        createdCanvas.style.width = '100%';\r\n        createdCanvas.style.height = '100%';\r\n        createdCanvas.style.backgroundColor = 'green';\r\n        userVideoDOM.parentElement.appendChild(createdCanvas);\r\n    } else {\r\n        const canvasElement = document.getElementsByClassName(userID);\r\n        if (canvasElement[0]) canvasElement[0].remove();\r\n    }\r\n}\r\n   \r\n\r\n}\r\n\r\n\r\nexport function createSocketConnectionInstance(settings={}) {\r\n    return  new SocketConnection(settings);\r\n}"]},"metadata":{},"sourceType":"module"}