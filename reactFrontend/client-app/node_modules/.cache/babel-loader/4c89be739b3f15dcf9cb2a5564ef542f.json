{"ast":null,"code":"import io from 'socket.io-client';\nimport Peer from 'peerjs';\n\nclass SocketConnection {\n  constructor(props) {\n    this.ENDPOINT = 'https://engage-video-app.herokuapp.com/';\n    this.peers = {};\n    this.videoContainer = {};\n    this.currentStream = null;\n    this.mediaRecorder = null;\n    this.screenShareStatus = true;\n    this.screenPresenter = false;\n    this.currentScreenShareID = null;\n    this.recordedChunks = [];\n    this.updatevalue = props.updatevalue;\n    this.roomId = props.roomId;\n    this.peer = this.newpeerconnection();\n    this.socket = io(this.ENDPOINT);\n    console.log('inside the connection :' + props.roomId);\n    this.socketEvent();\n    this.PeerEvent();\n    document.getElementById('screen-share').style.display = \"none\";\n    this.detectuseragent();\n  }\n\n  newpeerconnection() {\n    return new Peer({\n      config: {\n        'iceServers': [{\n          urls: ['stun:stun.l.google.com:19302', 'stun:stun3.l.google.com:19302', 'stun:stun.stunprotocol.org:3478']\n        }, {\n          urls: 'turn:3.108.196.62:3478',\n          credential: 'AdFs$8A0!21',\n          username: 'nighthawk'\n        }]\n      }\n    });\n  }\n  /************** ALL SOCKET & PEERJS REALTED FUCNTIONS *****************/\n\n\n  socketEvent() {\n    this.socket.on('screen-share', ID => {\n      console.log('screen-share view for:', ID);\n      this.currentScreenShareID = ID;\n      this.screenShareStatus = !this.screenShareStatus;\n      this.updatevalue('screenShareStatus', this.screenShareStatus);\n      this.screenShareView(ID, this.videoContainer[ID]);\n    });\n    this.socket.on('screen-share-newUser', (sharingId, DestId) => {\n      if (DestId === this.userId) {\n        this.currentScreenShareID = sharingId;\n        this.screenShareStatus = !this.screenShareStatus;\n        this.updatevalue('screenShareStatus', this.screenShareStatus);\n        console.log(\"replace video ID for new user\", sharingId);\n        var i = 0,\n            howManyTimes = 11;\n\n        const g = () => {\n          console.log(`waiting for sharefeed with ${i}`);\n\n          if (`${sharingId}` in this.videoContainer) {\n            this.screenShareView(sharingId, this.videoContainer[sharingId]);\n            i = 20;\n          }\n\n          i++;\n\n          if (i < howManyTimes) {\n            setTimeout(g, 1000);\n          } else if (i < 20) {\n            alert('Oops! something went wrong join the meet again to view shared screen');\n          }\n        };\n\n        g();\n      }\n    });\n    this.socket.on('normal-view', ID => {\n      console.log('REvert view for:', ID);\n      this.screenShareStatus = !this.screenShareStatus;\n      this.updatevalue('screenShareStatus', this.screenShareStatus);\n      this.currentScreenShareID = null;\n      this.screenShareRevert(ID);\n    });\n    this.socket.on('user-left', Id => {\n      if (this.currentScreenShareID === Id) {\n        this.screenShareStatus = !this.screenShareStatus;\n        this.updatevalue('screenShareStatus', this.screenShareStatus);\n        this.currentScreenShareID = null;\n        this.screenShareRevert(Id);\n      }\n\n      this.removeuser(Id);\n    });\n    this.socket.on('new-message', (userName, message) => {\n      this.updatevalue('Incomingmessage', {\n        userName: userName,\n        messageBody: message\n      });\n    });\n    this.socket.on('newuserName', userName => {\n      this.updatevalue('newuserName', {\n        userName: userName,\n        messageBody: ' joined chat'\n      });\n    });\n    this.socket.on('userleftchat', userName => {\n      this.updatevalue('newuserName', {\n        userName: userName,\n        messageBody: ' left chat'\n      });\n    });\n  }\n\n  PeerEvent() {\n    this.peer.on('open', id => {\n      this.userId = id;\n      console.log('generated userId: ' + id);\n      this.setlocalstream();\n      console.log(\"emitting joining room request\");\n      var i = 0,\n          howManyTimes = 11;\n\n      const f = () => {\n        console.log(`waiting for joining room with ${i}`);\n\n        if (`${this.userId}` in this.videoContainer) {\n          this.socket.emit('joining-room', this.roomId, id);\n          i = 20;\n        }\n\n        i++;\n\n        if (i < howManyTimes) {\n          setTimeout(f, 1500);\n        } else if (i < 20) {\n          /*if local stream cant be obtained*/\n          alert('Check camera/audio permissions and try again !');\n        }\n      };\n\n      f();\n    });\n    this.peer.on('error', err => {\n      console.log('reconnecting to peer', err);\n      alert(\"Check your internet connection and re-try\");\n      this.peer.reconnect();\n    });\n  }\n\n  setPeerListenres(stream) {\n    console.log('peerlisteners set');\n    this.peer.on('call', Call => {\n      Call.answer(stream);\n      Call.on('stream', externalstream => {\n        console.log('incoming stream');\n        this.peers[Call.metadata.userId] = Call.peerConnection;\n        this.addstream(externalstream, Call.metadata.userId);\n      });\n    });\n  }\n  /************END OF SOCKET & PEER HADNLING FUNCTIONS ***************/\n\n  /***************HANDLING NEW USER JOINED **************************/\n\n\n  newUserConnection() {\n    this.socket.on('user-joined', Id => {\n      console.log(\"joined use:\" + Id);\n\n      if (this.screenPresenter) {\n        this.socket.emit('screen-share-newUser', this.userId, Id);\n        console.log('screen-share req sent for new user');\n      }\n\n      this.connectToUser(this.currentStream, Id);\n    });\n  }\n\n  connectToUser(stream, Id) {\n    const call = this.peer.call(Id, stream, {\n      metadata: {\n        userId: this.userId\n      }\n    });\n    this.peer.on('error', err => {\n      console.log(\"ERROR\" + err);\n    });\n    console.log('made call to ' + Id + 'stream');\n    call.on('stream', externalstream => {\n      console.log('connteced user returned stream', externalstream);\n      this.addstream(externalstream, Id);\n    });\n    this.peers[Id] = call.peerConnection;\n  }\n  /*************END OF USER JOIED FUCNTIONS **********************/\n\n  /******************** AUDIO & VIDEO STREAM HANDLING **********************/\n\n\n  setlocalstream() {\n    this.getvideoaudio(true, true).then(stream => {\n      this.localstream = stream;\n      this.currentStream = stream; //To mute audio and video on start\n\n      this.videotoggle(true);\n      this.mictoggle(true);\n      this.addstream(stream, this.userId);\n      this.setPeerListenres(this.currentStream);\n      this.newUserConnection();\n    }).catch(function (err) {\n      console.log(err.name + \": \" + err.message);\n    });\n  }\n\n  getvideoaudio(videostatus, micstatus) {\n    const myNavigator = navigator.mediaDevices.getUserMedia || navigator.mediaDevices.webkitGetUserMedia || navigator.mediaDevices.mozGetUserMedia || navigator.mediaDevices.msGetUserMedia;\n    return myNavigator({\n      video: videostatus,\n      audio: micstatus\n    });\n  }\n\n  addstream(stream, Id) {\n    if (!this.videoContainer[Id]) {\n      const videogrid = document.getElementById('video-grid');\n      this.videoContainer[Id] = stream;\n      const localcontainer = document.createElement('div');\n      const video = document.createElement('video');\n      video.srcObject = stream;\n      video.id = Id;\n      video.autoplay = true;\n      if (this.userId === Id) video.muted = true;\n      localcontainer.appendChild(video);\n      videogrid.append(localcontainer);\n      console.log(\"done creating video :\" + Id);\n    }\n  }\n\n  removeuser(Id) {\n    if (this.peers[Id]) this.peers[Id].close();\n    delete this.videoContainer[Id];\n    const video = document.getElementById(Id);\n    if (video) video.remove();\n    delete this.peers[Id];\n  }\n\n  videotoggle(videostatus) {\n    if (this.localstream) {\n      this.localstream.getVideoTracks()[0].enabled = !videostatus;\n      this.updatevalue('videoStatus', !videostatus);\n    }\n  }\n\n  mictoggle(micStatus) {\n    if (this.localstream) {\n      this.localstream.getAudioTracks()[0].enabled = !micStatus;\n      this.updatevalue('micStatus', !micStatus);\n    }\n  }\n  /**********************END OF AUDIO & VIDEO HANDLING ****************/\n\n  /********************* SCREENSHARE FUNCTIONS**********************/\n\n\n  screenShareView(Id, mediaStream) {\n    var video = document.getElementById(Id);\n\n    if (video) {\n      video.pause();\n      video.style.display = \"none\";\n    }\n\n    const tmp = document.getElementById('screen-share');\n    tmp.style.display = \"inline\";\n    tmp.srcObject = mediaStream;\n    tmp.autoplay = true;\n\n    if (Id === this.userId) {\n      tmp.muted = true;\n    }\n\n    console.log(\"video elemnt\", tmp);\n  }\n\n  screenShareRevert(Id) {\n    const tmp = document.getElementById('screen-share');\n\n    if (tmp) {\n      tmp.pause();\n      tmp.srcObject = null;\n      tmp.style.display = \"none\";\n    }\n\n    var video = document.getElementById(Id);\n\n    if (video) {\n      video.style.display = \"inline\";\n      video.play();\n    }\n  }\n\n  screenSharetoggle(toggle) {\n    if (toggle) {\n      if (!this.screenShareStatus) return;\n      navigator.mediaDevices.getDisplayMedia({\n        video: {\n          cursor: \"always\"\n        },\n        audio: {\n          echoCancellation: true,\n          noiseSuppression: true\n        }\n      }).then(mediaStream => {\n        mediaStream.getVideoTracks()[0].onended = () => {\n          this.stopscreen();\n        };\n\n        if (mediaStream) {\n          this.socket.emit('screen-share', this.userId);\n          console.log('screen-share req sent');\n          this.currentStream = mediaStream;\n          this.screenShareStatus = !this.screenShareStatus;\n          this.updatevalue('screenShareStatus', this.screenShareStatus);\n          this.screenPresenter = !this.screenPresenter;\n          this.updatevalue('screenPresenter', this.screenPresenter);\n          this.screenShareView(this.userId, mediaStream);\n\n          for (const [key, value] of Object.entries(this.peers)) {\n            value.getSenders().map(sender => {\n              if (sender.track.kind === \"video\") {\n                if (mediaStream.getVideoTracks().length > 0) {\n                  sender.replaceTrack(mediaStream.getVideoTracks()[0]);\n                }\n              }\n            });\n          }\n        }\n      }).catch(err => {\n        console.log(\"unable to get screen stream\" + err);\n      });\n    } else {\n      this.stopscreen();\n    }\n  }\n\n  stopscreen() {\n    if (!this.screenPresenter) return;\n    this.socket.emit('normal-view', this.userId);\n    this.screenPresenter = !this.screenPresenter;\n    this.screenShareStatus = !this.screenShareStatus;\n    this.updatevalue('screenShareStatus', this.screenShareStatus);\n    this.updatevalue('screenPresenter', this.screenPresenter);\n    this.screenShareRevert(this.userId);\n    var video = document.getElementById(this.userId);\n\n    if (video) {\n      video.pause();\n      video.srcObject = this.localstream;\n      video.play();\n    }\n\n    this.currentStream = this.localstream;\n\n    for (const [key, value] of Object.entries(this.peers)) {\n      value.getSenders().map(sender => {\n        if (sender.track.kind === \"video\") {\n          if (this.localstream.getVideoTracks().length > 0) {\n            sender.replaceTrack(this.localstream.getVideoTracks()[0]);\n          }\n        }\n\n        if (sender.track.kind === \"audio\") {\n          if (this.localstream.getAudioTracks().length > 0) {\n            sender.replaceTrack(this.localstream.getAudioTracks()[0]);\n          }\n        }\n      });\n    }\n  }\n  /***********************END OF SCREENSHARE FUNCTIONS  ********************************/\n\n  /***********************SCREEN RECORDING FUNCTIONS ***********************************/\n\n\n  recordScreen(recordStatus) {\n    if (recordStatus) {\n      navigator.mediaDevices.getDisplayMedia({\n        video: {\n          cursor: \"always\"\n        },\n        audio: {\n          echoCancellation: true,\n          noiseSuppression: true\n        }\n      }).then(mediaStream => {\n        this.mediaRecorder = new MediaRecorder(mediaStream);\n        this.startrecording();\n\n        mediaStream.getVideoTracks()[0].onended = () => {\n          this.endrecording();\n        };\n      }).catch(err => {\n        console.log(\"unable to get screen stream for recording\" + err);\n      });\n    } else {\n      this.endrecording();\n    }\n  }\n\n  startrecording() {\n    this.updatevalue('recordStatus', false);\n    console.log(\"starting\", this.mediaRecorder);\n\n    this.mediaRecorder.ondataavailable = event => {\n      if (event.data.size > 0) {\n        this.recordedChunks.push(event.data);\n      }\n    };\n\n    this.mediaRecorder.onstop = () => {\n      const blob = new Blob(this.recordedChunks, {\n        'type': 'video/mp4'\n      });\n      console.log(this.recordedChunks.length);\n      const url = URL.createObjectURL(blob);\n      const a = document.createElement('a');\n      a.style.display = 'none';\n      a.href = url;\n      var today = new Date();\n      var date = today.getFullYear() + '-' + (today.getMonth() + 1) + '-' + today.getDate();\n      var time = today.getHours() + ':' + today.getMinutes() + ':' + today.getSeconds();\n      var dateTime = date + '-' + time;\n      a.download = 'Recording/' + dateTime + '.mp4';\n      document.body.appendChild(a);\n      a.click();\n      setTimeout(() => {\n        document.body.removeChild(a);\n        window.URL.revokeObjectURL(url);\n      }, 200);\n      this.recordedChunks = [];\n    };\n\n    this.mediaRecorder.start(1500);\n  }\n\n  endrecording() {\n    if (this.mediaRecorder) {\n      console.log(\"ending\", this.mediaRecorder);\n      this.updatevalue('recordStatus', true);\n      this.mediaRecorder.stop();\n      this.mediaRecorder = null;\n    }\n  }\n  /*********************END OF SCREENRECORDING FUCNTIONS ****************************/\n\n  /******************* CHAT FUNCTIONS *******************************/\n\n\n  broadcastmessage(newmessage, userName) {\n    if (this.socket) {\n      this.socket.emit('new-message', userName, newmessage);\n    }\n  }\n\n  newuserChat(name) {\n    setTimeout(() => {\n      if (this.socket) {\n        this.socket.emit('newuserName', name);\n      }\n    }, 1500);\n  }\n  /************************* END OF CHAT FUNCTIONS *********************/\n\n\n  detectuseragent() {\n    if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|BB|PlayBook|IEMobile|Windows Phone|Kindle|Silk|Opera Mini/i.test(navigator.userAgent)) {\n      document.getElementById('options-button').style.display = \"none\";\n    }\n  }\n\n  exitcall(username) {\n    if (this.screenPresenter) {\n      this.socket.emit('normal-view', this.userId);\n    }\n\n    this.socket.emit('userleftchat', username);\n    this.socket.disconnect();\n\n    if (this.videoContainer[this.userId]) {\n      const Tracks = this.videoContainer[this.userId].getTracks();\n      Tracks.forEach(element => {\n        element.stop();\n      });\n    }\n\n    delete this.videoContainer;\n    delete this.peer;\n    delete this.peers;\n  }\n\n}\n\nexport function createSocketConnectionInstance(settings = {}) {\n  return new SocketConnection(settings);\n}","map":{"version":3,"sources":["E:/Microsoft ENgae/reactFrontend/client-app/src/connectionServices/Connection.js"],"names":["io","Peer","SocketConnection","constructor","props","ENDPOINT","peers","videoContainer","currentStream","mediaRecorder","screenShareStatus","screenPresenter","currentScreenShareID","recordedChunks","updatevalue","roomId","peer","newpeerconnection","socket","console","log","socketEvent","PeerEvent","document","getElementById","style","display","detectuseragent","config","urls","credential","username","on","ID","screenShareView","sharingId","DestId","userId","i","howManyTimes","g","setTimeout","alert","screenShareRevert","Id","removeuser","userName","message","messageBody","id","setlocalstream","f","emit","err","reconnect","setPeerListenres","stream","Call","answer","externalstream","metadata","peerConnection","addstream","newUserConnection","connectToUser","call","getvideoaudio","then","localstream","videotoggle","mictoggle","catch","name","videostatus","micstatus","myNavigator","navigator","mediaDevices","getUserMedia","webkitGetUserMedia","mozGetUserMedia","msGetUserMedia","video","audio","videogrid","localcontainer","createElement","srcObject","autoplay","muted","appendChild","append","close","remove","getVideoTracks","enabled","micStatus","getAudioTracks","mediaStream","pause","tmp","play","screenSharetoggle","toggle","getDisplayMedia","cursor","echoCancellation","noiseSuppression","onended","stopscreen","key","value","Object","entries","getSenders","map","sender","track","kind","length","replaceTrack","recordScreen","recordStatus","MediaRecorder","startrecording","endrecording","ondataavailable","event","data","size","push","onstop","blob","Blob","url","URL","createObjectURL","a","href","today","Date","date","getFullYear","getMonth","getDate","time","getHours","getMinutes","getSeconds","dateTime","download","body","click","removeChild","window","revokeObjectURL","start","stop","broadcastmessage","newmessage","newuserChat","test","userAgent","exitcall","disconnect","Tracks","getTracks","forEach","element","createSocketConnectionInstance","settings"],"mappings":"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","sourcesContent":["import io from 'socket.io-client';\r\nimport Peer from 'peerjs';\r\n\r\n\r\nclass SocketConnection {\r\n    ENDPOINT='https://engage-video-app.herokuapp.com/';\r\n    peers={};\r\n    videoContainer={};\r\n    currentStream=null;\r\n    mediaRecorder=null;\r\n    screenShareStatus=true;\r\n    screenPresenter=false;\r\n    currentScreenShareID=null;\r\n    recordedChunks=[];\r\n    constructor(props)\r\n    {   this.updatevalue=props.updatevalue;\r\n        this.roomId=props.roomId;\r\n        this.peer=this.newpeerconnection();\r\n        this.socket=io(this.ENDPOINT);\r\n        console.log('inside the connection :'+props.roomId);\r\n        this.socketEvent();\r\n        this.PeerEvent();\r\n        document.getElementById('screen-share').style.display = \"none\";\r\n       this.detectuseragent();\r\n        \r\n    }\r\n\r\n    newpeerconnection()\r\n    {\r\n        return new Peer({\r\n         config: {'iceServers': [\r\n             { urls: ['stun:stun.l.google.com:19302','stun:stun3.l.google.com:19302','stun:stun.stunprotocol.org:3478'] },\r\n             { urls: 'turn:3.108.196.62:3478', credential: 'AdFs$8A0!21',username:'nighthawk' }\r\n            \r\n           ]}\r\n \r\n        });\r\n    }\r\n\r\n    /************** ALL SOCKET & PEERJS REALTED FUCNTIONS *****************/\r\n \r\n   \r\n\r\n    socketEvent()\r\n    {\r\n        this.socket.on('screen-share',(ID)=>{\r\n            console.log('screen-share view for:',ID);\r\n            this.currentScreenShareID=ID;\r\n            this.screenShareStatus=!this.screenShareStatus;\r\n            this.updatevalue('screenShareStatus',this.screenShareStatus);\r\n           this.screenShareView(ID,this.videoContainer[ID]);\r\n        })\r\n\r\n\r\n        this.socket.on('screen-share-newUser',(sharingId,DestId)=>{\r\n            if(DestId===this.userId)\r\n            {\r\n                this.currentScreenShareID=sharingId;\r\n                this.screenShareStatus=!this.screenShareStatus;\r\n                this.updatevalue('screenShareStatus',this.screenShareStatus);\r\n                console.log(\"replace video ID for new user\",sharingId);\r\n\r\n                \r\n                var i = 0, howManyTimes = 11;\r\n                const g=()=>{\r\n                console.log(`waiting for sharefeed with ${i}`)\r\n                if(`${sharingId}` in this.videoContainer)\r\n                    {\r\n                        this.screenShareView(sharingId,this.videoContainer[sharingId]);\r\n                      \r\n                        i=20;\r\n                    }\r\n                i++;\r\n                if (i < howManyTimes) {\r\n                    setTimeout(g, 1000);\r\n                }\r\n                else if(i<20){\r\n                    alert('Oops! something went wrong join the meet again to view shared screen');\r\n                }\r\n                }\r\n    \r\n                g();\r\n               \r\n                 \r\n                \r\n               \r\n                \r\n            }\r\n        })\r\n\r\n\r\n        this.socket.on('normal-view',(ID)=>{\r\n            console.log('REvert view for:',ID);\r\n            this.screenShareStatus=!this.screenShareStatus;\r\n            this.updatevalue('screenShareStatus',this.screenShareStatus);\r\n            this.currentScreenShareID=null;\r\n            this.screenShareRevert(ID);\r\n        })\r\n\r\n        this.socket.on('user-left',(Id)=>{\r\n            if(this.currentScreenShareID===Id)\r\n            { this.screenShareStatus=!this.screenShareStatus;\r\n                this.updatevalue('screenShareStatus',this.screenShareStatus);\r\n                this.currentScreenShareID=null;\r\n                this.screenShareRevert(Id);\r\n            }\r\n            this.removeuser(Id);\r\n        })\r\n\r\n        this.socket.on('new-message',(userName,message)=>{\r\n          \r\n            this.updatevalue('Incomingmessage',{userName:userName, messageBody:message});  \r\n           \r\n        })\r\n\r\n        this.socket.on('newuserName',(userName)=>{\r\n            this.updatevalue('newuserName',{userName:userName,messageBody: ' joined chat'});\r\n        })\r\n\r\n\r\n        this.socket.on('userleftchat',(userName)=>{\r\n            this.updatevalue('newuserName',{userName:userName,messageBody: ' left chat'});\r\n        })\r\n       \r\n    }\r\n\r\n\r\n    PeerEvent()\r\n    {\r\n       \r\n        this.peer.on('open',(id) =>{\r\n            this.userId=id;\r\n            console.log('generated userId: '+id);\r\n            this.setlocalstream();\r\n            console.log(\"emitting joining room request\")\r\n         \r\n            var i = 0, howManyTimes = 11;\r\n\r\n            const f=()=>{\r\n            console.log(`waiting for joining room with ${i}`)\r\n            if(`${this.userId}` in this.videoContainer)\r\n                {\r\n                    this.socket.emit('joining-room', this.roomId, id);\r\n                  \r\n                    i=20;\r\n                }\r\n            i++;\r\n            if (i < howManyTimes) {\r\n                setTimeout(f, 1500);\r\n            }\r\n            else if(i<20){\r\n                /*if local stream cant be obtained*/\r\n                alert('Check camera/audio permissions and try again !');\r\n            }\r\n            }\r\n\r\n            f();\r\n           \r\n            \r\n           \r\n               \r\n            });\r\n\r\n\r\n        this.peer.on('error',(err)=>{\r\n           console.log('reconnecting to peer',err);\r\n           alert(\"Check your internet connection and re-try\");\r\n           this.peer.reconnect();\r\n       });\r\n      \r\n        \r\n    }\r\n     \r\n\r\n\r\n    setPeerListenres(stream)\r\n    {\r\n        console.log('peerlisteners set');\r\n        this.peer.on('call', (Call) =>{\r\n           \r\n            Call.answer(stream);\r\n            Call.on('stream',(externalstream)=>{\r\n             console.log('incoming stream');\r\n             this.peers[Call.metadata.userId]=Call.peerConnection;\r\n                this.addstream(externalstream,Call.metadata.userId);\r\n            })\r\n          \r\n        })\r\n    }\r\n \r\n     \r\n    /************END OF SOCKET & PEER HADNLING FUNCTIONS ***************/\r\n\r\n\r\n\r\n\r\n\r\n\r\n    /***************HANDLING NEW USER JOINED **************************/\r\n\r\n    newUserConnection()\r\n    {\r\n        this.socket.on('user-joined',(Id)=>{\r\n           \r\n            console.log(\"joined use:\"+Id);\r\n          \r\n            if(this.screenPresenter)\r\n            {\r\n                this.socket.emit('screen-share-newUser',this.userId,Id);\r\n                console.log('screen-share req sent for new user');\r\n            }\r\n                this.connectToUser(this.currentStream,Id);\r\n            \r\n            \r\n            \r\n        });\r\n      \r\n\r\n    }\r\n\r\n\r\n    connectToUser(stream,Id)\r\n        {\r\n       \r\n            const call=this.peer.call(Id,stream,{ metadata: { userId: this.userId } });\r\n            this.peer.on('error',(err)=>{\r\n                console.log(\"ERROR\"+err);\r\n            })\r\n            console.log('made call to '+ Id+ 'stream');\r\n            call.on('stream',(externalstream)=>{\r\n                console.log('connteced user returned stream',externalstream);\r\n                this.addstream(externalstream,Id);\r\n            })\r\n           \r\n            this.peers[Id]=call.peerConnection;\r\n          \r\n        }\r\n   \r\n    /*************END OF USER JOIED FUCNTIONS **********************/\r\n\r\n\r\n    \r\n   \r\n    /******************** AUDIO & VIDEO STREAM HANDLING **********************/\r\n\r\n\r\n\r\n    setlocalstream()\r\n    { \r\n        \r\n       this.getvideoaudio(true,true).then((stream)=> {\r\n            this.localstream=stream;\r\n            this.currentStream=stream;\r\n            //To mute audio and video on start\r\n            this.videotoggle(true);\r\n            this.mictoggle(true);\r\n\r\n            this.addstream(stream,this.userId);\r\n            this.setPeerListenres(this.currentStream);\r\n            this.newUserConnection();\r\n\r\n      })\r\n      .catch(function(err) { console.log(err.name + \": \" + err.message); });\r\n     \r\n    }\r\n\r\n\r\n    getvideoaudio(videostatus,micstatus)\r\n    {\r\n        const myNavigator = navigator.mediaDevices.getUserMedia || navigator.mediaDevices.webkitGetUserMedia || navigator.mediaDevices.mozGetUserMedia || navigator.mediaDevices.msGetUserMedia;\r\n        return myNavigator({video:videostatus,audio :micstatus});\r\n    }\r\n    \r\n    \r\n    addstream(stream,Id)\r\n   {\r\n       if(!this.videoContainer[Id])\r\n       {\r\n        const videogrid=document.getElementById('video-grid');\r\n      \r\n        this.videoContainer[Id]=stream;\r\n        const localcontainer = document.createElement('div');\r\n        const video = document.createElement('video');\r\n        video.srcObject =stream;\r\n        video.id=Id;\r\n        video.autoplay = true;\r\n        if (this.userId === Id) video.muted = true;\r\n        localcontainer.appendChild(video)\r\n        videogrid.append(localcontainer);\r\n        console.log(\"done creating video :\"+Id);\r\n       \r\n        \r\n       }\r\n      \r\n   }\r\n\r\n   removeuser(Id)\r\n   {\r\n    if(this.peers[Id])this.peers[Id].close();\r\n    delete this.videoContainer[Id];\r\n    const video = document.getElementById(Id);\r\n    if (video) video.remove();\r\n    delete this.peers[Id];\r\n    \r\n\r\n   }\r\n   \r\n\r\n\r\n   videotoggle(videostatus)\r\n   {\r\n       if(this.localstream)\r\n       {\r\n        this.localstream.getVideoTracks()[0].enabled =!videostatus; \r\n        this.updatevalue('videoStatus',!videostatus);\r\n       }\r\n   \r\n   }\r\n\r\n\r\n   mictoggle(micStatus)\r\n   {\r\n       if(this.localstream)\r\n       {    \r\n        this.localstream.getAudioTracks()[0].enabled =!micStatus;\r\n        this.updatevalue('micStatus',!micStatus);\r\n\r\n       }\r\n    \r\n   }\r\n\r\n/**********************END OF AUDIO & VIDEO HANDLING ****************/\r\n\r\n\r\n\r\n /********************* SCREENSHARE FUNCTIONS**********************/\r\n\r\n\r\n   screenShareView(Id,mediaStream)\r\n   {\r\n    var video = document.getElementById(Id);\r\n          if(video)\r\n          {\r\n            video.pause();\r\n            video.style.display=\"none\";\r\n         \r\n          }\r\n        const tmp=document.getElementById('screen-share');\r\n        tmp.style.display=\"inline\";\r\n        tmp.srcObject=mediaStream;\r\n        tmp.autoplay=true;\r\n        if(Id===this.userId)\r\n        {\r\n            tmp.muted=true;\r\n        }\r\n        console.log(\"video elemnt\",tmp);\r\n\r\n   }\r\n\r\n\r\n\r\n\r\n   screenShareRevert(Id)\r\n   {\r\n    const tmp=document.getElementById('screen-share');\r\n    if(tmp)\r\n    {\r\n        tmp.pause();\r\n        tmp.srcObject=null;\r\n        tmp.style.display=\"none\";\r\n    }\r\n    var video = document.getElementById(Id);\r\n          if(video)\r\n          {\r\n           \r\n            video.style.display=\"inline\";\r\n            video.play();\r\n          }\r\n  \r\n   \r\n    \r\n   }\r\n\r\n\r\n\r\n   screenSharetoggle(toggle)\r\n   { \r\n\r\n       if(toggle)\r\n       {\r\n        if(!this.screenShareStatus)\r\n                return;\r\n   \r\n    \r\n    \r\n           navigator.mediaDevices.getDisplayMedia({\r\n           video: {\r\n               cursor: \"always\"\r\n           },\r\n           audio: {\r\n               echoCancellation: true,\r\n               noiseSuppression: true\r\n\r\n           }\r\n            }).then((mediaStream)=>{\r\n        \r\n        \r\n        \r\n           mediaStream.getVideoTracks()[0].onended=()=>\r\n           {\r\n             \r\n           this.stopscreen();\r\n           }\r\n     \r\n           if(mediaStream)\r\n           {\r\n             this.socket.emit('screen-share',this.userId);\r\n             console.log('screen-share req sent');\r\n             this.currentStream=mediaStream;\r\n             this.screenShareStatus=!this.screenShareStatus;\r\n             this.updatevalue('screenShareStatus',this.screenShareStatus);\r\n             this.screenPresenter=!this.screenPresenter;\r\n             this.updatevalue('screenPresenter',this.screenPresenter);\r\n             this.screenShareView(this.userId,mediaStream);\r\n           \r\n\r\n           \r\n          \r\n            for (const [key, value] of Object.entries(this.peers)) {\r\n            \r\n                value.getSenders().map((sender) => {\r\n                \r\n                    if(sender.track.kind ===\"video\") {\r\n                        if(mediaStream.getVideoTracks().length > 0){\r\n                            sender.replaceTrack(mediaStream.getVideoTracks()[0]);\r\n                        }\r\n                    }\r\n\r\n\r\n                    \r\n                });\r\n                 }\r\n         \r\n             }\r\n          \r\n         \r\n\r\n            }).catch((err)=>{\r\n             console.log(\"unable to get screen stream\"+err)\r\n            })\r\n\r\n       }\r\n       else\r\n       {\r\n        this.stopscreen();\r\n       }\r\n    \r\n           \r\n   }\r\n   \r\n \r\n    stopscreen()\r\n    {if(!this.screenPresenter)\r\n        return;\r\n        \r\n       this.socket.emit('normal-view',this.userId);\r\n       this.screenPresenter=!this.screenPresenter;\r\n       this.screenShareStatus=!this.screenShareStatus;\r\n       this.updatevalue('screenShareStatus',this.screenShareStatus);\r\n       this.updatevalue('screenPresenter',this.screenPresenter);\r\n        this.screenShareRevert(this.userId);\r\n        var video = document.getElementById(this.userId);\r\n        if(video)\r\n        {\r\n            video.pause();\r\n            video.srcObject = this.localstream;\r\n            video.play();\r\n        }\r\n         \r\n          this.currentStream=this.localstream\r\n        for (const [key, value] of Object.entries(this.peers)) {\r\n            \r\n            value.getSenders().map((sender) => {\r\n            \r\n                if(sender.track.kind === \"video\") {\r\n                    if(this.localstream.getVideoTracks().length > 0){\r\n                        sender.replaceTrack(this.localstream.getVideoTracks()[0]);\r\n                    }\r\n                }\r\n\r\n                if(sender.track.kind === \"audio\") {\r\n                    if(this.localstream.getAudioTracks().length > 0){\r\n                        sender.replaceTrack(this.localstream.getAudioTracks()[0]);\r\n                    }\r\n                }\r\n            });\r\n        }\r\n    }\r\n\r\n\r\n\r\n\r\n    /***********************END OF SCREENSHARE FUNCTIONS  ********************************/\r\n\r\n\r\n\r\n\r\n\r\n\r\n    /***********************SCREEN RECORDING FUNCTIONS ***********************************/\r\n\r\n    recordScreen(recordStatus){\r\n\r\n        if(recordStatus)\r\n        {\r\n            navigator.mediaDevices.getDisplayMedia({\r\n                video: {\r\n                    cursor: \"always\"\r\n                },\r\n                audio: {\r\n                    echoCancellation: true,\r\n                    noiseSuppression: true\r\n     \r\n                }\r\n            }).then((mediaStream)=>{\r\n               \r\n             \r\n               this.mediaRecorder=new MediaRecorder(mediaStream);\r\n               this.startrecording();\r\n               mediaStream.getVideoTracks()[0].onended=()=>\r\n               {\r\n                 \r\n               this.endrecording();\r\n               }\r\n            \r\n            }).catch((err)=>{\r\n                console.log(\"unable to get screen stream for recording\"+err)\r\n            })\r\n            \r\n        }\r\n        else \r\n        {\r\n           \r\n            this.endrecording();\r\n           \r\n        }\r\n        \r\n    }\r\n\r\n\r\n    startrecording()\r\n    {   \r\n        this.updatevalue('recordStatus',false);\r\n       \r\n        console.log(\"starting\",this.mediaRecorder);\r\n      \r\n        this.mediaRecorder.ondataavailable=(event)=>{\r\n        \r\n        if (event.data.size > 0) {\r\n            this.recordedChunks.push(event.data);\r\n                }\r\n            }   \r\n\r\n        this.mediaRecorder.onstop=()=>{\r\n                const blob = new Blob(this.recordedChunks,{'type': 'video/mp4'});\r\n                console.log(this.recordedChunks.length);\r\n                const url = URL.createObjectURL(blob);\r\n                const a = document.createElement('a');\r\n                a.style.display = 'none';\r\n                a.href = url;\r\n                var today = new Date();\r\n                var date = today.getFullYear()+'-'+(today.getMonth()+1)+'-'+today.getDate();\r\n                var time = today.getHours() + ':' + today.getMinutes() + ':' + today.getSeconds();\r\n                var dateTime = date+'-'+time;\r\n                a.download = 'Recording/'+dateTime+'.mp4';\r\n                document.body.appendChild(a);\r\n                a.click();\r\n                setTimeout(() => {\r\n                  document.body.removeChild(a);\r\n                  window.URL.revokeObjectURL(url);\r\n                }, 200);\r\n                this.recordedChunks=[];\r\n            }\r\n        this.mediaRecorder.start(1500);\r\n    }\r\n    \r\n    \r\n    endrecording()\r\n    {\r\n        if(this.mediaRecorder)\r\n        {\r\n            console.log(\"ending\",this.mediaRecorder);\r\n            this.updatevalue('recordStatus',true);\r\n            this.mediaRecorder.stop();\r\n            this.mediaRecorder=null;\r\n              \r\n        }\r\n       \r\n    }\r\n\r\n\r\n    /*********************END OF SCREENRECORDING FUCNTIONS ****************************/\r\n\r\n\r\n\r\n    /******************* CHAT FUNCTIONS *******************************/\r\n\r\n\r\n    broadcastmessage(newmessage,userName)\r\n    {\r\n        if(this.socket)\r\n        {\r\n            this.socket.emit('new-message',userName,newmessage);\r\n        }\r\n    }\r\n\r\n    newuserChat(name)\r\n    {\r\n     setTimeout(()=>{ if(this.socket)\r\n         {\r\n          this.socket.emit('newuserName',name);\r\n         }},1500);\r\n       \r\n    }\r\n\r\n    \r\n    /************************* END OF CHAT FUNCTIONS *********************/\r\n\r\n\r\n\r\n\r\n    detectuseragent()\r\n    {\r\n        if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|BB|PlayBook|IEMobile|Windows Phone|Kindle|Silk|Opera Mini/i.test(navigator.userAgent)) {\r\n            document.getElementById('options-button').style.display = \"none\";\r\n        }\r\n    }\r\n\r\n\r\n    exitcall(username)\r\n    {\r\n     \r\n     if(this.screenPresenter)\r\n     {\r\n        this.socket.emit('normal-view',this.userId);\r\n     }\r\n     this.socket.emit('userleftchat',username);\r\n     this.socket.disconnect();\r\n     if(this.videoContainer[this.userId])\r\n     {\r\n         const Tracks = this.videoContainer[this.userId].getTracks();\r\n         Tracks.forEach(element => {element.stop();\r\n             \r\n         });\r\n     }\r\n    \r\n        delete(this.videoContainer);\r\n        delete(this.peer);\r\n        delete(this.peers);\r\n       \r\n    }\r\n \r\n  \r\n    \r\n\r\n   \r\n \r\n}\r\n\r\n\r\n\r\n\r\nexport function createSocketConnectionInstance(settings={}) {\r\n    return  new SocketConnection(settings);\r\n}"]},"metadata":{},"sourceType":"module"}